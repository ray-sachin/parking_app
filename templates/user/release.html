{% extends 'base.html' %}

{% block title %}Release Parking Spot - Vehicle Parking System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2><i class="fas fa-sign-out-alt me-2"></i>Release Parking Spot</h2>
    </div>
    <div class="col-md-4 text-end">
        <a href="{{ url_for('user.dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-7">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-car me-2"></i>Release Your Spot</h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <h5>Current Reservation Details</h5>
                    <table class="table">
                        <tr>
                            <th>Parking Lot:</th>
                            <td>{{ lot.name }}</td>
                        </tr>
                        <tr>
                            <th>Address:</th>
                            <td>{{ lot.address }}, {{ lot.pin_code }}</td>
                        </tr>
                        <tr>
                            <th>Spot Number:</th>
                            <td>{{ spot.spot_number }}</td>
                        </tr>
                        <tr>
                            <th>Vehicle Number:</th>
                            <td>{{ reservation.vehicle_number }}</td>
                        </tr>
                        <tr>
                            <th>Parking Time:</th>
                            <td>{{ reservation.parking_time_ist.strftime('%d/%m/%Y %H:%M:%S') }}</td>
                        </tr>
                        <tr>
                            <th>Hourly Rate:</th>
                            <td>₹{{ lot.price }}</td>
                        </tr>
                        <tr>
                            <th>Time Elapsed:</th>
                            <td id="timeElapsed">Calculating...</td>
                        </tr>
                        <tr>
                            <th>Estimated Cost:</th>
                            <td id="estimatedCost">Calculating...</td>
                        </tr>
                    </table>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Once you release the spot, your reservation will be completed and you'll be charged for the time used.
                </div>
                
                <form method="POST" action="{{ url_for('user.release') }}">
                    {{ form.hidden_tag() }}
                    <div class="d-grid mt-4">
                        {{ form.submit(class="btn btn-danger btn-lg") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-5">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Release Information</h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <h6><i class="fas fa-tasks me-2 text-primary"></i>What happens when you release</h6>
                    <ol>
                        <li>Your parking session will be ended</li>
                        <li>The system will calculate the total time spent</li>
                        <li>The final cost will be determined based on the hourly rate</li>
                        <li>The spot will become available for other users</li>
                        <li>This reservation will be added to your history</li>
                    </ol>
                </div>
                
                <div>
                    <h6><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Important Notes</h6>
                    <ul>
                        <li>Make sure your vehicle has actually left the spot</li>
                        <li>You cannot undo a release action</li>
                        <li>If you need to park again, you'll need to make a new reservation</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set the date we're counting from
        const parkingTime = new Date('{{ reservation.parking_time.isoformat() }}Z');
        const hourlyRate = {{ lot.price }};
        const timeElapsedElement = document.getElementById('timeElapsed');
        const estimatedCostElement = document.getElementById('estimatedCost');
        
        function updateTimer() {
            // Get current time
            const now = new Date();
            
            // Find the difference between now and the parking time
            const diff = now - parkingTime;
            
            // Time calculations for hours, minutes and seconds
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            // Display the time elapsed
            timeElapsedElement.textContent = `${hours} hrs, ${minutes} mins, ${seconds} secs`;
            
            // Calculate cost
            const hoursDecimal = diff / (1000 * 60 * 60);
            const cost = hoursDecimal * hourlyRate;
            estimatedCostElement.textContent = `₹${cost.toFixed(2)}`;
        }
        
        // Update the timer every second
        updateTimer();
        setInterval(updateTimer, 1000);
    });
</script>
{% endblock %}