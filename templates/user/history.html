{% extends 'base.html' %}

{% block title %}Parking History - Vehicle Parking System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2><i class="fas fa-history me-2"></i>Parking History</h2>
    </div>
    <div class="col-md-4 text-end">
        <a href="{{ url_for('user.dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>
</div>

{% if reservation_details %}
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
      <h5 class="mb-0">Your Reservations</h5>
    </div>
    <div class="table-responsive">
      <table class="table table-hover mb-0" id="historyTable">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Parking Lot</th>
            <th>Spot #</th>
            <th>Vehicle</th>
            <th>Duration</th>
            <th>Cost</th>
            <th>Status</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          {% for detail in reservation_details %}
          <tr>
            <td>{{ detail.reservation.parking_time_ist.strftime('%d/%m/%Y') }}</td>
            <td>{{ detail.lot.name }}</td>
            <td>{{ detail.spot.spot_number }}</td>
            <td>{{ detail.reservation.vehicle_number }}</td>
            <td>
              {% if detail.reservation.leaving_time %}
                {% set mins = ((detail.reservation.leaving_time_ist - detail.reservation.parking_time_ist).total_seconds() // 60) %}
                {% if mins < 60 %}
                  {{ mins }} mins
                {% else %}
                  {{ (mins // 60) }} hrs {{ (mins % 60) }} mins
                {% endif %}
              {% else %}
                Active
              {% endif %}
            </td>
            <td>
              {% if detail.reservation.parking_cost %}
                ₹{{ detail.reservation.parking_cost }}
              {% else %}
                –
              {% endif %}
            </td>
            <td>
              {% if detail.reservation.is_active %}
                <span class="badge bg-success">Active</span>
              {% else %}
                <span class="badge bg-secondary">Completed</span>
              {% endif %}
            </td>
            <td>
              <button type="button"
                      class="btn btn-sm btn-info"
                      data-bs-toggle="modal"
                      data-bs-target="#reservationModal{{ detail.reservation.id }}">
                <i class="fas fa-eye"></i>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card-footer">
      <div class="d-flex justify-content-center">
        <nav aria-label="Parking history pagination">
          <ul class="pagination">
            {% if pagination.has_prev %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('user.history', page=pagination.prev_num) }}">Previous</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">Previous</span>
              </li>
            {% endif %}

            {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
              {% if p %}
                <li class="page-item {% if p == pagination.page %}active{% endif %}" >
                  <a class="page-link" href="{{ url_for('user.history', page=p) }}" style="color: white;">{{ p }}</a>
                </li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
              {% endif %}
            {% endfor %}

            {% if pagination.has_next %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('user.history', page=pagination.next_num) }}">Next</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">Next</span>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
  </div>

  {# ===== Modals: placed outside the table for stability ===== #}
  {% for detail in reservation_details %}
  <div class="modal fade"
       id="reservationModal{{ detail.reservation.id }}"
       tabindex="-1"
       aria-labelledby="reservationLabel{{ detail.reservation.id }}"
       aria-hidden="true"
       data-bs-backdrop="static"
       data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reservationLabel{{ detail.reservation.id }}">
            Reservation Details
          </h5>
          <button type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close">
          </button>
        </div>
        <div class="modal-body">
          <table class="table table-bordered mb-0">
            <tr><th>Reservation ID</th><td>{{ detail.reservation.id }}</td></tr>
            <tr><th>Parking Lot</th><td>{{ detail.lot.name }}</td></tr>
            <tr>
              <th>Address</th>
              <td>{{ detail.lot.address }}, {{ detail.lot.pin_code }}</td>
            </tr>
            <tr><th>Spot Number</th><td>{{ detail.spot.spot_number }}</td></tr>
            <tr><th>Vehicle Number</th><td>{{ detail.reservation.vehicle_number }}</td></tr>
            <tr>
              <th>Parking Time</th>
              <td>
                {{ detail.reservation.parking_time_ist.strftime('%d/%m/%Y %H:%M:%S') }}
              </td>
            </tr>
            <tr>
              <th>Leaving Time</th>
              <td>
                {% if detail.reservation.leaving_time_ist %}
                  {{ detail.reservation.leaving_time_ist.strftime('%d/%m/%Y %H:%M:%S') }}
                {% else %}
                  –
                {% endif %}
              </td>
            </tr>
            <tr><th>Hourly Rate</th><td>₹{{ detail.lot.price }}</td></tr>
            <tr>
              <th>Total Cost</th>
              <td>
                {% if detail.reservation.parking_cost %}
                  ₹{{ detail.reservation.parking_cost }}
                {% else %}
                  –
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Status</th>
              <td>
                {% if detail.reservation.is_active %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-secondary">Completed</span>
                {% endif %}
              </td>
            </tr>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}

{% else %}
  <div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>
    You don't have any parking history yet.
  </div>
  <div class="text-center my-5">
    <i class="fas fa-car fa-5x text-muted mb-3"></i>
    <h4>No Parking History</h4>
    <p>Once you reserve and release parking spots, your history will appear here.</p>
    <a href="{{ url_for('user.reserve') }}" class="btn btn-primary mt-3">
      <i class="fas fa-car me-2"></i>Reserve a Spot Now
    </a>
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
  {# No extra JS needed; Bootstrap’s data attributes handle the modals #}
{% endblock %}
