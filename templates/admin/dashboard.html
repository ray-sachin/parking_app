{% extends 'base.html' %}

{% block title %}Admin Dashboard - Vehicle Parking System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2><i class="fas fa-tachometer-alt me-2"></i>Admin Dashboard</h2>
    </div>
    <div class="col-md-4 text-end">
        <a href="{{ url_for('admin.new_parking_lot') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Add New Parking Lot
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Total Parking Lots</h6>
                        <h2 class="mb-0">{{ total_lots }}</h2>
                    </div>
                    <i class="fas fa-building fa-3x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Available Spots</h6>
                        <h2 class="mb-0">{{ available_spots }}</h2>
                    </div>
                    <i class="fas fa-parking fa-3x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Occupied Spots</h6>
                        <h2 class="mb-0">{{ occupied_spots }}</h2>
                    </div>
                    <i class="fas fa-car fa-3x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Registered Users</h6>
                        <h2 class="mb-0">{{ total_users }}</h2>
                    </div>
                    <i class="fas fa-users fa-3x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">Parking Lots Overview</h5>
            </div>
            <div class="card-body">
                <canvas id="lotOccupancyChart" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">Overall Occupancy</h5>
            </div>
            <div class="card-body text-center">
                <canvas id="overallOccupancyChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Parking Lots</h5>
                <a href="{{ url_for('admin.parking_lots') }}" class="btn btn-sm btn-primary">View All</a>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Price/Hour</th>
                            <th>Address</th>
                            <th>Total Spots</th>
                            <th>Available</th>
                            <th>Occupied</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lot in parking_lots %}
                        <tr>
                            <td>{{ lot.id }}</td>
                            <td>{{ lot.name }}</td>
                            <td>â‚¹{{ lot.price }}</td>
                            <td>{{ lot.address }}, {{ lot.pin_code }}</td>
                            <td>{{ lot.max_spots }}</td>
                            <td>{{ lot.count_available_spots() }}</td>
                            <td>{{ lot.count_occupied_spots() }}</td>
                            <td>
                                <a href="{{ url_for('admin.parking_spots', lot_id=lot.id) }}" class="btn btn-sm btn-info">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ url_for('admin.edit_parking_lot', lot_id=lot.id) }}" class="btn btn-sm btn-warning">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Prepare data for lot occupancy chart
        const lotNames = [];
        const availableSpots = [];
        const occupiedSpots = [];
        
        {% for lot in parking_lots %}
            lotNames.push('{{ lot.name }}');
            availableSpots.push({{ lot.count_available_spots() }});
            occupiedSpots.push({{ lot.count_occupied_spots() }});
        {% endfor %}
        
        // Lot occupancy chart
        const lotOccupancyCtx = document.getElementById('lotOccupancyChart').getContext('2d');
        const lotOccupancyChart = new Chart(lotOccupancyCtx, {
            type: 'bar',
            data: {
                labels: lotNames,
                datasets: [
                    {
                        label: 'Available',
                        data: availableSpots,
                        backgroundColor: 'rgba(40, 167, 69, 0.7)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Occupied',
                        data: occupiedSpots,
                        backgroundColor: 'rgba(220, 53, 69, 0.7)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Overall occupancy chart
        const overallOccupancyCtx = document.getElementById('overallOccupancyChart').getContext('2d');
        const overallOccupancyChart = new Chart(overallOccupancyCtx, {
            type: 'doughnut',
            data: {
                labels: ['Available', 'Occupied'],
                datasets: [{
                    data: [{{ available_spots }}, {{ occupied_spots }}],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.7)',
                        'rgba(220, 53, 69, 0.7)'
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(220, 53, 69, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    });
</script>
{% endblock %}